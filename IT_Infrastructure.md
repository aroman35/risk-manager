# ИТ-инфраструктура и программные компоненты проекта

## 1. Общий обзор
Проект исследует адаптивное управление рисками MR‑стратегий на криптовалютных рынках.  
Техническая архитектура состоит из пяти ключевых компонентов, связанных единой средой данных и вычислений.

Инфраструктура разворачивается в **Yandex Cloud** (грант 104 000 ₽), обеспечивая хранение данных, вычислительные ноды для Python‑анализов и сервисы на .NET для оркестрации бэктестов.

---

## 2. Компонент 1 — Сборщик рыночных данных и база TimescaleDB

**Репозиторий:** [market‑data‑storage](https://github.com/aroman35/market-data-storage)  
**Язык:** C# + SQL  
**Назначение:** агрегирование и сохранение рыночных данных с бирж (Tardis.dev, Binance, OKX) в формат TimescaleDB.

### Функции
- Асинхронный импорт потоков trades/quotes/funding.  
- Сжатие и партиционирование данных по временным чанкам.  
- REST API для выборки баров и котировок.  
- Метаданные: версия датасета, источник, частота, символ, timestamp диапазон.

### Инфраструктура
- **TimescaleDB 17** в Yandex Managed PostgreSQL.  
- Хранилище `/data/md-cache` монтируется как volume в сборщике.  
- Поддержка Timescale compression и continuous aggregates.

---

## 3. Компонент 2 — Бэктест‑матчер (.NET)

**Язык:** C# (.NET 8)  
**Назначение:** низкоуровневый движок сопоставления ордеров и расчёта PnL, латентности и исполнения сигналов MR‑стратегии.

### Архитектура
- Паттерн *matching engine* с кольцевым буфером ордеров (lock‑free, Span\<T\>).  
- Импорт данных из TimescaleDB (через Npgsql или gRPC API).  
- Поддержка нескольких стратегий MR с параметрами $\Theta_t=\{\gamma_t,\lambda_t,\kappa_t,\mu_t\}$.  
- Логирование исполнений, latency, проскальзывания.

### Планируемые модули
- Parser (market events)  
- OrderMatcher (limit/market)  
- PnLCalculator  
- RiskLimiter (execution VaR/ES)  
- MetricsExporter (Prometheus/OpenTelemetry)

---

## 4. Компонент 3 — Оркестратор бэктестов (C# + Hangfire)

**Назначение:** централизованное управление сериями экспериментов и балансировка вычислений.

### Реализация
- ASP.NET Core Web API + Hangfire для планирования и очередей.  
- PostgreSQL storage для Hangfire jobs.  
- gRPC API для запуска/остановки бэктестов и запроса статуса.  
- Поддержка распределённых воркеров (Yandex Cloud Compute Instances).  
- Авторизация через API‑ключи, логирование в ELK.

### Основные задачи
- Постановка задач с параметрами MR/EVT (rolling windows, пороги).  
- Мониторинг загрузки, приоритетов и статусов.  
- Хранение метаданных запусков для последующей аналитики.

---

## 5. Компонент 4 — Подготовка данных и обучение моделей (Python)

**Назначение:** предобработка данных из TimescaleDB, обучение и экспорт моделей для onnx‑инференса.

### Технологии
- **Python 3.11**, библиотеки: `pandas`, `polars`, `statsmodels`, `arch`, `scikit-learn`, `onnx`, `onnxruntime`.  
- Подключение к TimescaleDB через `asyncpg`/`SQLAlchemy`.  
- MLFlow/wandb для трекинга экспериментов.  
- Экспорт обученных моделей в формат **ONNX** для интеграции в .NET бэктест‑движок.

### Этапы
1. Выборка данных по SQL‑запросам (tick → бар).  
2. Калибровка MR‑параметров (AR/OU/GARCH).  
3. Оценка EVT (POT/GEV) и классификация режимов.  
4. Объединение в датасет для обучения адаптивного контроллера.  
5. Сохранение модели и версий параметров.

---

## 6. Компонент 5 — Интерпретация результатов и отчётность (Python)

**Назначение:** визуализация результатов бэктестов и формирование отчётов.

### Реализация
- Jupyter + `matplotlib`, `plotly`, `seaborn`, `dash`.  
- Подключение к API оркестратора для загрузки результатов.  
- Формирование сводных таблиц (PnL, Sharpe, VaR‑исключения, EVT‑режимы).  
- Автоматический экспорт в Markdown/PDF для включения в отчёт по исследованию.

---

## 7. Инфраструктура Yandex Cloud

### Используемые сервисы
| Компонент | Сервис | Примечание |
|------------|---------|-------------|
| TimescaleDB | Managed PostgreSQL | Основное хранилище данных |
| Оркестратор / Matcher | Compute Cloud (VMs, auto‑scaling) | Воркеры .NET 8 |
| Python‑модули | DataProc / Serverless Functions | Запуск задач анализа |
| Общее хранилище | Object Storage (S3‑совместимый) | Логи, артефакты, модели |
| Мониторинг | Yandex Monitoring + Grafana | Метрики, алерты |
| Сеть | VPC с NAT Gateway | Безопасный доступ к API |

### Принципы использования гранта
- Минимизация простоев, авто‑остановка неактивных VM.  
- Отделение dev/test/prod окружений.  
- Снимки TimescaleDB для бэкапов.  
- Использование бесплатных лимитов Serverless‑сервисов для Python задач.

---

## 8. Потоки данных и взаимодействие компонентов

```text
 Tardis / Binance / OKX
         ↓
  [market‑data‑storage]  → TimescaleDB  ←→  Python‑анализ
                                   ↓
                              Backtest Matcher (.NET)
                                   ↓
                           Orchestrator (Hangfire API)
                                   ↓
                      Python Reports / Dashboards / ONNX
```

---

## 9. Безопасность и контроль версий
- Доступ по сервисным аккаунтам IAM Yandex Cloud.  
- Secrets (API keys, DB creds) — в Yandex Lockbox / Vault.  
- GitHub Actions CI/CD для .NET и Python модулей.  
- Логи и артефакты — в Object Storage (версионирование).

---

## 10. Итоги
Архитектура сочетает TimescaleDB как ядро хранения, .NET‑компоненты для бэктеста и оркестрации, Python‑модули для анализа и отчётности, с размещением в Yandex Cloud.  
Такая структура обеспечивает воспроизводимость, масштабируемость и интеграцию вычислений и данных в одном контуре.
